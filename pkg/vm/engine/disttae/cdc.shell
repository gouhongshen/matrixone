#!/bin/bash

mysql -h127.0.0.1 -P6001 -udump -p111 -e "drop database if exists tpcc; create database tpcc;"
mysql -h127.0.0.1 -P6001 -udump -p111 -e "drop pitr if exists pitr_db;"
mysql -h127.0.0.1 -P6001 -udump -p111 -e "drop cdc task cdc_tpcc;"
# shellcheck disable=SC2164
cd /Users/ghs-mo/MOWorkSpace/mo-tpcc
./runSQL.sh props.mo tableCreates
mysql -h127.0.0.1 -P6001 -udump -p111 -e "use tpcc; source /Users/ghs-mo/MOWorkSpace/mo-tpcc/sql/loadData10.sql;"
mysql -h127.0.0.1 -P6001 -udump -p111 -e "create  pitr pitr_db for database tpcc  range 24 'h';"
mysql -h127.0.0.1 -P6001 -udump -p111 -e "
create cdc cdc_tpcc
    'mysql://dump:111@127.0.0.1:6001'
    'matrixone' 'mysql://dump:111@127.0.0.1:6001'
    'tpcc.bmsql_stock:tpcc_bak.bmsql_stock'
    {'Level'='table'};
"

while true; do
    result=$(mysql -h127.0.0.1 -P6001 -udump -p111 -e "select count(*) from tpcc_bak.bmsql_stock;" 2>/dev/null)

   if echo "$result" | grep -q "1000000"; then
           echo "tpcc_bak.bmsql_stock reached 1000000, exiting."
           break
       else
           sleep 1
       fi
done

mysql -h127.0.0.1 -P6001 -udump -p111 -e "pause cdc task cdc_tpcc;"

# shellcheck disable=SC2164
cd /Users/ghs-mo/MOWorkSpace/mo-tpcc
./runBenchmark.sh props.mo

mysql -h127.0.0.1 -P6001 -udump -p111 -e "resume cdc task cdc_tpcc;"